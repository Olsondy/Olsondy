<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"olsond.tech","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="工作备忘记录">
<meta property="og:type" content="article">
<meta property="og:title" content="开发备忘录">
<meta property="og:url" content="https://olsond.tech/articles/2023/05/23/memos/index.html">
<meta property="og:site_name" content="Olsond">
<meta property="og:description" content="工作备忘记录">
<meta property="og:locale">
<meta property="article:published_time" content="2023-05-23T07:52:08.683Z">
<meta property="article:modified_time" content="2023-12-12T09:35:19.412Z">
<meta property="article:author" content="olsond">
<meta property="article:tag" content="workspace">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://olsond.tech/articles/2023/05/23/memos/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>开发备忘录 | Olsond</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Olsond</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">try to be alive</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Olsondy" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://olsond.tech/articles/2023/05/23/memos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar_olsond.jpg">
      <meta itemprop="name" content="olsond">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Olsond">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          开发备忘录
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-05-23 15:52:08" itemprop="dateCreated datePublished" datetime="2023-05-23T15:52:08+08:00">2023-05-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-12 17:35:19" itemprop="dateModified" datetime="2023-12-12T17:35:19+08:00">2023-12-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Develop/" itemprop="url" rel="index"><span itemprop="name">Develop</span></a>
                </span>
            </span>

          
            <div class="post-description">工作备忘记录</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Spring-boot-相关"><a href="#Spring-boot-相关" class="headerlink" title="Spring boot 相关"></a>Spring boot 相关</h1><h2 id="纠错"><a href="#纠错" class="headerlink" title="纠错"></a>纠错</h2><blockquote>
<p>首先，bootstrap.yml作为配置文件，是在springcloud中实现的，而不是springboot！<br>sb根本就不会加载bootstrap.yml！<br>百度的答案都是sb中这两者区别，错到德玛西亚去了。</p>
</blockquote>
<ul>
<li><strong>认识bootstrap.yml</strong><br>在springcloud中，使用bootstrap首先加载一些配置，这部分是高优先级不会被后续覆盖的。<br>通常是用做加载配置中心配置。不要在这里配置其他属性，会出现很诡异的事。(我测了，配置0000，得出0)所以就乖乖的按照springcloud的建议来。最后，<code>bootstrap.yml</code>作为配置文件，是springcloud中的定义</li>
</ul>
<h2 id="Spring-Cloud-Open-Fegin"><a href="#Spring-Cloud-Open-Fegin" class="headerlink" title="Spring Cloud Open Fegin"></a>Spring Cloud Open Fegin</h2><ul>
<li><p>FEIGN是走HTTP的，即使利用接口特性做成类RPC的方式，但也还是走HTTP的。但是就我使用感受，速度还行，比想象中要快。rpc固然速度比http快，但是你要考虑的稳定性、数据传输的可靠性、熔断保护，以及更方便的链路监控和追踪，这时候HTTP的优势就体现了。</p>
</li>
<li><p>Spring cloud的http从以下几个方面可以优化</p>
<ul>
<li>换成okhttp3。</li>
<li>应用中不要做异步传输，防止异步等待，如果遇到异步场景，一定要利用好消息队列和缓存。</li>
<li>如果http1.1，有些场景利用keep-alive，减少连接损耗。</li>
<li>可以考虑尝试HTTP/2</li>
</ul>
</li>
</ul>
<h2 id="Springboot2-x"><a href="#Springboot2-x" class="headerlink" title="Springboot2.x"></a>Springboot2.x</h2><ul>
<li> Spring boot 2.x 无法使用<code>servlet: context-path</code>, 采用的是 <code>spring.webflux.base-path:</code></li>
<li>@ConditionalOnProperty 注解介绍<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123; ElementType.TYPE, ElementType.METHOD &#125;)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Conditional(OnPropertyCondition.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ConditionalOnProperty &#123;</span><br><span class="line">  <span class="comment">// 数组，获取对应property名称的值，与name不可同时使用</span></span><br><span class="line">  String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">  <span class="comment">// 配置属性名称的前缀，比如spring.http.encoding</span></span><br><span class="line">  <span class="function">String <span class="title">prefix</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">  <span class="comment">// 数组，配置属性完整名称或部分名称</span></span><br><span class="line">  <span class="comment">// 可与prefix组合使用，组成完整的配置属性名称，与value不可同时使用</span></span><br><span class="line">  String[] name() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">  <span class="comment">// 可与name组合使用，比较获取到的属性值与havingValue给定的值是否相同，相同才加载配置</span></span><br><span class="line">  <span class="function">String <span class="title">havingValue</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">  <span class="comment">// 缺少该配置属性时是否可以加载。如果为true，没有该配置属性时也会正常加载；反之则不会生效</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">matchIfMissing</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Springboot-data-redis-和data-elasticsearch中的netty冲突"><a href="#Springboot-data-redis-和data-elasticsearch中的netty冲突" class="headerlink" title="Springboot data redis 和data-elasticsearch中的netty冲突"></a>Springboot data redis 和data-elasticsearch中的netty冲突</h2><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul>
<li><code>spring-data-elasticsearch</code> 和 <code>spring-boot-data-redis</code>都是使用的netty作为通信框架, 如果在加载时优先加载redis 链接的bean, 那么后续es创建时会导致启动失败, 异常日志 <code>Caused by: java.lang.IllegalStateException: availableProcessors is already set to [4], rejecting [4]</code></li>
<li>具体原因在elasticsearch项目的这个类中有实现, 原因是又针对netty的处理器配置设置了一次参数,导致nettyRutime时检测到重复赋值…<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.elasticsearch.transport.netty4;</span><br><span class="line"><span class="comment">// 省略....</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Netty4Utils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicBoolean isAvailableProcessorsSet = <span class="keyword">new</span> AtomicBoolean();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set the number of available processors that Netty uses for sizing various resources (e.g., thread pools).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> availableProcessors the number of available processors</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if available processors was set previously and the specified value does not match the already-set value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAvailableProcessors</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> availableProcessors)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// we set this to false in tests to avoid tests that randomly set processors from stepping on each other</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> set = Booleans.parseBoolean(System.getProperty(<span class="string">&quot;es.set.netty.runtime.available.processors&quot;</span>, <span class="string">&quot;true&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (set == <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This can be invoked twice, once from Netty4Transport and another time from Netty4HttpServerTransport; however,</span></span><br><span class="line"><span class="comment">         * Netty4Runtime#availableProcessors forbids settings the number of processors twice so we prevent double invocation here.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (isAvailableProcessorsSet.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            NettyRuntime.setAvailableProcessors(availableProcessors);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availableProcessors != NettyRuntime.availableProcessors()) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * We have previously set the available processors yet either we are trying to set it to a different value now or there is a bug</span></span><br><span class="line"><span class="comment">             * in Netty and our previous value did not take, bail.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">final</span> String message = String.format(</span><br><span class="line">                Locale.ROOT,</span><br><span class="line">                <span class="string">&quot;available processors value [%d] did not match current value [%d]&quot;</span>,</span><br><span class="line">                availableProcessors,</span><br><span class="line">                NettyRuntime.availableProcessors()</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><a target="_blank" rel="noopener" href="https://discuss.elastic.co/t/need-info-for-es-set-netty-runtime-available-processors/111322/2">为什么设置默认值?</a></li>
</ul>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><ul>
<li>github的<a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch/issues/41176">issus</a></li>
<li>将es配置优先加载</li>
<li>启动类中添加覆盖配置<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">	System.setProperty(<span class="string">&quot;es.set.netty.runtime.available.processors&quot;</span>, <span class="string">&quot;false&quot;</span>);  </span><br><span class="line">	SpringApplication.run(Application.class, args);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">	System.setProperty(<span class="string">&quot;es.set.netty.runtime.available.processors&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>启动时添加启动参数也可以覆盖配置 <code>-Des.set.netty.runtime.available.processors=false</code></li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><blockquote>
<p>如果集成了其他使用netty的相关框架在spring boot配置类中加载, 都会导致和<code>elasticserach</code>配置冲突造成启动失败, 例如: <code>spring-boot-starter-actuator</code>中的<code>elasticsearch</code>健康检查配置</p>
</blockquote>
<h2 id="spring-boot中的-Order注解"><a href="#spring-boot中的-Order注解" class="headerlink" title="spring-boot中的@Order注解"></a>spring-boot中的@Order注解</h2><ul>
<li>通过@Order注解来注入集合时，指定顺序的场景, 首先我们定义两个Bean实现同一个接口，并添加上@Order注解<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBean</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Order(2)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnoBean1</span> <span class="keyword">implements</span> <span class="title">IBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name = <span class="string">&quot;ano order bean 1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AnoBean1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Order(1)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnoBean2</span> <span class="keyword">implements</span> <span class="title">IBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name = <span class="string">&quot;ano order bean 2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AnoBean2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>然后在一个测试bean中，注入IBean的列表，我们需要测试这个列表中的Bean的顺序是否和我们定义的@Order规则一致<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnoTestBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AnoTestBean</span><span class="params">(List&lt;IBean&gt; anoBeanList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (IBean bean : anoBeanList) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;in ano testBean: &quot;</span> + bean.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>根据我们的预期, anoBeanList集合中，anoBean2应该在前面<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ano order bean 1</span><br><span class="line">ano order bean 2</span><br><span class="line">in ano testBean:com.git.hui.boot.beanorder.order.right.ano.order.AnoBean2</span><br><span class="line">in ano testBean:com.git.hui.boot.beanorder.order.right.ano.order.AnoBean1</span><br></pre></td></tr></table></figure></li>
<li>只能决定使用顺序不能指定初始化加载顺序.</li>
</ul>
<h2 id="spring-boot-依赖外部jar的使用"><a href="#spring-boot-依赖外部jar的使用" class="headerlink" title="spring-boot 依赖外部jar的使用"></a>spring-boot 依赖外部jar的使用</h2><h3 id="依赖配置"><a href="#依赖配置" class="headerlink" title="依赖配置"></a>依赖配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">	<span class="comment">&lt;!-- groupId 和 artifactId随意填写--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.cfit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>af-as-third-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>$&#123;pom.basedir&#125;/../lib/xxxx.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="打包配置"><a href="#打包配置" class="headerlink" title="打包配置"></a>打包配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">			    <span class="comment">&lt;!-- 一定要有这个配置 --&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">includeSystemScope</span>&gt;</span>true<span class="tag">&lt;/<span class="name">includeSystemScope</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.project.lombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="spring-interceptor使用注意项"><a href="#spring-interceptor使用注意项" class="headerlink" title="spring interceptor使用注意项"></a>spring interceptor使用注意项</h2><blockquote>
<p>如不是特殊情况需要在拦截器interceptor中获取body的, 建议替换成filter实现或者一定要声明filter搭配interceptor进行request包装类来将body向下传递,  原因是在执行优先级<code>filter &gt; interceptor &gt; controller</code> 中的body内容是inputStream形式向下传递的,  如果在interceptor中取出了body内容, 会导致filter传递完的inputStream无法继续向下传递, 而controller无法获取到参数, 产生stream is closed异常</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Spring-boot-validator-校验-和-独立配置返回消息内容整合"><a href="#Spring-boot-validator-校验-和-独立配置返回消息内容整合" class="headerlink" title="Spring boot validator 校验 和 独立配置返回消息内容整合"></a>Spring boot validator 校验 和 独立配置返回消息内容整合</h2><p><code>spring boot validator</code>是由<code>hibernate-validator</code>实现的, <code>hibernate-validator</code> 使用的是 <code>JSR-303</code> 的默认<code>ValidationMessages.properties</code>包, 所以需要手动设置加载自定义<code>springboot message</code> 文件</p>
<blockquote>
<p>官方解释: 指定用于解析验证消息的自定义 <code>Spring MessageSource</code>，而不是依赖 JSR-303 的默认<code>ValidationMessages.properties</code>包,在类路径中。 这可能指的是 Spring 上下文的共享<code>messageSource</code></p>
</blockquote>
<h3 id="加载自定义消息配置文件"><a href="#加载自定义消息配置文件" class="headerlink" title="加载自定义消息配置文件"></a>加载自定义消息配置文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Specify a custom Spring MessageSource for resolving validation messages,</span></span><br><span class="line"><span class="comment"> * instead of relying on JSR-303&#x27;s default &quot;ValidationMessages.properties&quot; bundle</span></span><br><span class="line"><span class="comment"> * in the classpath. This may refer to a Spring context&#x27;s shared &quot;messageSource&quot; bean,</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocalValidatorFactoryBean <span class="title">localValidatorFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	LocalValidatorFactoryBean localValidatorFactoryBean = <span class="keyword">new</span> LocalValidatorFactoryBean();</span><br><span class="line">	ReloadableResourceBundleMessageSource messageSource = <span class="keyword">new</span> ReloadableResourceBundleMessageSource();</span><br><span class="line">	messageSource.setBasename(<span class="string">&quot;classpath:message&quot;</span>); <span class="comment">// 这里加载自定message.properties文件</span></span><br><span class="line">	localValidatorFactoryBean.setValidationMessageSource(messageSource);</span><br><span class="line">	<span class="keyword">return</span> localValidatorFactoryBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>问题:</strong> <code>LocalValidatorFactoryBean</code>设置自定义的<code>messageSource</code>不生效, 是由于项目中有配置继承了<code>WebMvcConfigurationSupport</code>类, 导致<code>Validator</code>实例会被该配置中的<code>OptionalValidatorFactoryBean</code>类创建的<code>LocalValidatorFactoryBean</code>覆盖掉丢失<code>messageSource</code><br><strong>解决:</strong> 修改当前配置继承的<code>WebMvcConfigurationSupport</code>类替换成实现<code>WebMvcConfigurer</code>即可,这样会加载自定义重写的springmvc配置, spring mvc会判断是否加载了<code>Validator</code>直接使用</p>
</blockquote>
<h4 id="聚合工程多模块message文件的处理"><a href="#聚合工程多模块message文件的处理" class="headerlink" title="聚合工程多模块message文件的处理"></a>聚合工程多模块message文件的处理</h4><ul>
<li><p>重写spring-boot的<code>MessageSourceAutoConfiguration</code>中的<code>MessageSource</code>不使用<code>ResourceBundleMessageSource</code> 而使用 <code>ReloadableResourceBundleMessageSource</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MessageSource <span class="title">messageSource</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ReloadableResourceBundleMessageSource reloadableResourceBundleMessageSource =</span><br><span class="line">            <span class="keyword">new</span> ReloadableResourceBundleMessageSource();</span><br><span class="line">    reloadableResourceBundleMessageSource.setDefaultEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    PathMatchingResourcePatternResolver resourcePatternResolver = <span class="keyword">new</span> PathMatchingResourcePatternResolver();</span><br><span class="line">    Resource[] resources = resourcePatternResolver.getResources(<span class="string">&quot;classpath*:message*&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (resources.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Set&lt;String&gt; urlSet = Arrays.stream(resources).map(resource -&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> resource.getURL().toString().replace(<span class="string">&quot;.properties&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).collect(Collectors.toSet());</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtil.isNotEmpty(urlSet)) &#123;</span><br><span class="line">            reloadableResourceBundleMessageSource.setBasenames(urlSet.toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reloadableResourceBundleMessageSource.setBasename(<span class="string">&quot;messages&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> reloadableResourceBundleMessageSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>不重写配置, 直接在yaml设置多个文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">messages:</span></span><br><span class="line">    <span class="attr">basename:</span> <span class="string">message,message_shared</span></span><br><span class="line">    <span class="attr">encoding:</span> <span class="string">UTF-8</span></span><br></pre></td></tr></table></figure>
<h4 id="声明校验错误提示信息配置"><a href="#声明校验错误提示信息配置" class="headerlink" title="声明校验错误提示信息配置"></a>声明校验错误提示信息配置</h4></li>
<li><p>设置引用变量</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># message.properties</span></span><br><span class="line"><span class="meta">name.length.validation</span>=<span class="string">名称长度只允许在&#123;min&#125; ~ &#123;max&#125;之间</span></span><br></pre></td></tr></table></figure></li>
<li><p>在实体类中属性上使用相关注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Length(min = 8, max = 100, message = &quot;&#123;name.length.validation&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure></li>
<li><p>还可以使用<code>MessageSource</code>进行动态添加占位符参数, 调整返回的校验消息内容</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># message.properties</span></span><br><span class="line"><span class="meta">name.length.validation</span>=<span class="string">&#123;0&#125; 名称长度只允许在&#123;min&#125; ~ &#123;max&#125;之间</span></span><br></pre></td></tr></table></figure>
<h4 id="异常处理方法"><a href="#异常处理方法" class="headerlink" title="异常处理方法"></a>异常处理方法</h4></li>
<li><p>全局拦截, 在Controller声明的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">private</span> MessageSource messageSource;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 处理调用接口validator失败抛出的异常</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@ExceptionHandler(BindException.class)</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> ResponseResult&lt;Void&gt; <span class="title">bindExceptionHandler</span><span class="params">(MethodArgumentNotValidException argumentNotValidException)</span> </span>&#123;</span><br><span class="line">     List&lt;FieldError&gt; fieldErrors = argumentNotValidException.getBindingResult().getFieldErrors();</span><br><span class="line">     List&lt;String&gt; collect = fieldErrors.stream()</span><br><span class="line">             <span class="comment">// 如果不使用messageSource进行参数处理,则可直接返回fieldError.getDefaultMessage()</span></span><br><span class="line">             .map(fieldError -&gt; getMessage(fieldError.getDefaultMessage(), <span class="keyword">new</span> Object[]&#123;fieldError.getField()&#125;, fieldError.getDefaultMessage(), LocaleContextHolder.getLocale()))</span><br><span class="line">             .collect(Collectors.toList());</span><br><span class="line">     <span class="keyword">return</span> ResponseResult.error(String.valueOf(HttpStatus.BAD_REQUEST.value()), <span class="string">&quot;数据验证失败，不合法的参数格式，请核对！&quot;</span>, collect);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">(String code, Object[] args, String defaultMessage, Locale locale)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> messageSource.getMessage(code, args, defaultMessage, locale);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>如果是在方法层级校验, 需要设置自定义的校验器, 否则无法返回<code>mesages.properties</code>的错误消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置方法验证后处理器的校验器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MethodValidationPostProcessor <span class="title">methodValidationPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	MethodValidationPostProcessor methodValidationPostProcessor = <span class="keyword">new</span> MethodValidationPostProcessor();</span><br><span class="line">	methodValidationPostProcessor.setValidator(localValidatorFactoryBean());</span><br><span class="line">	<span class="keyword">return</span> methodValidationPostProcessor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>接口中使用注解方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">mergeUser</span> <span class="params">(<span class="meta">@NotBlank(message=&quot;&#123;name.isNotBlank&#125;&quot;)</span></span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="meta">@Length(max=10, message=&quot;&quot;&#123;name.length.validation&#125;&quot;)</span> String name)</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Springboot使用-RequestPart"><a href="#Springboot使用-RequestPart" class="headerlink" title="Springboot使用 @RequestPart"></a>Springboot使用 @RequestPart</h2><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p>使用可以需要将文件和对象分参数一起提交, 请求content-type类型是<code>multipart/form-data</code>传递</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><ul>
<li><p>前端参数封装example (by vue)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> studentVo = &#123; &#125;</span><br><span class="line"><span class="keyword">const</span> formData = <span class="keyword">new</span> FormData();</span><br><span class="line">formData.append(<span class="string">&quot;file&quot;</span>,  file) </span><br><span class="line">formData.append(<span class="string">&quot;studentVO&quot;</span>,  <span class="keyword">new</span> Blob([<span class="built_in">JSON</span>.stringify(studentVo)], &#123;<span class="attr">type</span>: <span class="string">&quot;application/json&quot;</span>&#125;));</span><br><span class="line">axios.post(<span class="string">&#x27;url&#x27;</span>, formData, &#123;<span class="attr">headers</span>: &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;multipart/form-data&#x27;</span>&#125;&#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;).catch(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li><p>后端接口example</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = &quot;/upload&quot;)</span>  </span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">uploadStuInfo</span> <span class="params">(<span class="meta">@RequestPart(&quot;file&quot;)</span> MultipartFile multipartFile, <span class="meta">@RequestPart</span> StudentVO studentVO)</span> </span>&#123;  </span><br><span class="line"><span class="comment">// todo  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><blockquote>
<p> 如果后端参数定义的是对象, 前端一定需要转换成blob类型, 否则会提示 <code>org.springframework.web.HttpMediaTypeNotSupportedException: application/octet-stream....</code></p>
</blockquote>
<h2 id="spring-boot-内置tomcat设置"><a href="#spring-boot-内置tomcat设置" class="headerlink" title="spring boot 内置tomcat设置"></a>spring boot 内置tomcat设置</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TomcatServletWebServerFactory <span class="title">servletContainer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TomcatServletWebServerFactory factory = <span class="keyword">new</span> TomcatServletWebServerFactory();</span><br><span class="line">        factory.addContextCustomizers(context -&gt; &#123;</span><br><span class="line">            SecurityConstraint securityConstraint = <span class="keyword">new</span> SecurityConstraint();</span><br><span class="line">            securityConstraint.setUserConstraint(<span class="string">&quot;CONFIDENTIAL&quot;</span>);</span><br><span class="line">            SecurityCollection collection = <span class="keyword">new</span> SecurityCollection();</span><br><span class="line">            collection.addPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">            collection.addMethod(<span class="string">&quot;HEAD&quot;</span>);</span><br><span class="line">            collection.addMethod(<span class="string">&quot;PUT&quot;</span>);</span><br><span class="line">            collection.addMethod(<span class="string">&quot;PATCH&quot;</span>);</span><br><span class="line">            collection.addMethod(<span class="string">&quot;DELETE&quot;</span>);</span><br><span class="line">            collection.addMethod(<span class="string">&quot;TRACE&quot;</span>);</span><br><span class="line">            collection.addMethod(<span class="string">&quot;COPY&quot;</span>);</span><br><span class="line">            collection.addMethod(<span class="string">&quot;SEARCH&quot;</span>);</span><br><span class="line">            collection.addMethod(<span class="string">&quot;PROPFIND&quot;</span>);</span><br><span class="line">            securityConstraint.addCollection(collection);</span><br><span class="line">            context.addConstraint(securityConstraint);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 优化参数</span></span><br><span class="line">        factory.addConnectorCustomizers(connector -&gt; &#123;</span><br><span class="line">            connector.setAllowTrace(<span class="keyword">true</span>);</span><br><span class="line">			connector.setPort(<span class="number">8083</span>);</span><br><span class="line">			connector.setProperty(<span class="string">&quot;connectionTimeout&quot;</span>, <span class="string">&quot;30000&quot;</span>);</span><br><span class="line">             <span class="comment">//CPU数</span></span><br><span class="line">			connector.setProperty(<span class="string">&quot;acceptorThreadCount&quot;</span>, <span class="string">&quot;4&quot;</span>);</span><br><span class="line">			connector.setProperty(<span class="string">&quot;minSpareThreads&quot;</span>, <span class="string">&quot;50&quot;</span>);</span><br><span class="line">			connector.setProperty(<span class="string">&quot;maxSpareThreads&quot;</span>, <span class="string">&quot;50&quot;</span>);</span><br><span class="line">			connector.setProperty(<span class="string">&quot;maxThreads&quot;</span>, <span class="string">&quot;1000&quot;</span>);</span><br><span class="line">			connector.setProperty(<span class="string">&quot;maxConnections&quot;</span>, <span class="string">&quot;10000&quot;</span>);</span><br><span class="line">			connector.setProperty(<span class="string">&quot;protocol&quot;</span>, <span class="string">&quot;org.apache.coyote.http11.Http11Nio2Protocol&quot;</span>);</span><br><span class="line">			connector.setProperty(<span class="string">&quot;redirectPort&quot;</span>, <span class="string">&quot;443&quot;</span>);</span><br><span class="line">			connector.setProperty(<span class="string">&quot;compression&quot;</span>, <span class="string">&quot;on&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Ali-QL-Express-工具使用"><a href="#Ali-QL-Express-工具使用" class="headerlink" title="Ali QL Express 工具使用"></a>Ali QL Express 工具使用</h2><ul>
<li>初始化</li>
<li>转换表达式</li>
<li>执行</li>
</ul>
<h2 id="Java-Timer-vs-ExecutorService"><a href="#Java-Timer-vs-ExecutorService" class="headerlink" title="Java Timer vs ExecutorService?"></a>Java Timer vs ExecutorService?</h2><p>Q: I have code where I schedule a task using<code>java.util.Timer</code>. I was looking around and saw<code>ExecutorService</code>can do the same. So this question here, have you used<code>Timer</code>and<code>ExecutorService</code>to schedule tasks, what is the benefit of one using over another?</p>
<p>Also wanted to check if anyone had used the<code>Timer</code>class and ran into any issues which the<code>ExecutorService</code>solved for them.</p>
<p>A: </p>
<blockquote>
<p>According to<a target="_blank" rel="noopener" href="http://jcip.net/">Java Concurrency in Practice</a>:</p>
</blockquote>
<ul>
<li><code>Timer</code>can be sensitive to changes in the system clock,<code>ScheduledThreadPoolExecutor</code>isn’t.</li>
<li><code>Timer</code>has only one execution thread, so long-running task can delay other tasks.<code>ScheduledThreadPoolExecutor</code>can be configured with any number of threads. Furthermore, you have full control over created threads, if you want (by providing<code>ThreadFactory</code>).</li>
<li>Runtime exceptions thrown in<code>TimerTask</code>kill that one thread, thus making<code>Timer</code>dead :-( … i.e. scheduled tasks will not run anymore.<code>ScheduledThreadExecutor</code>not only catches runtime exceptions, but it lets you handle them if you want (by overriding<code>afterExecute</code>method from<code>ThreadPoolExecutor</code>). Task which threw exception will be canceled, but other tasks will continue to run.</li>
</ul>
<p>If you can use<code>ScheduledThreadExecutor</code>instead of<code>Timer</code>, do so.</p>
<p>One more thing… while<code>ScheduledThreadExecutor</code>isn’t available in Java 1.4 library, there is a<a target="_blank" rel="noopener" href="http://backport-jsr166.sourceforge.net/">Backport of JSR 166 (<code>java.util.concurrent</code>) to Java 1.2, 1.3, 1.4</a>, which has the<code>ScheduledThreadExecutor</code>class.</p>
<h2 id="Mapstruct-插件"><a href="#Mapstruct-插件" class="headerlink" title="Mapstruct 插件"></a>Mapstruct 插件</h2><ul>
<li><p>idea 安装mapstruct support 插件, 写expression好用</p>
</li>
<li><p> 不同类型使用代码表达式转换, <code>@Mapping</code>注解可以设置某个属性映射关系, <code>expression</code>表达式则是实现的源代码, 也可以使用<code>@Mapper</code>注解中导入的实现类的方法名</p>
</li>
<li><p> 如果表达式中含有导入的外部包, 则使用 <code>@Mapper(import=&#123;Arrays.class&#125;</code> 类似引入即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MergeRuleConfigConvert</span> <span class="keyword">extends</span> <span class="title">BaseConvert</span>&lt;<span class="title">RuleConfigMergeVO</span>, <span class="title">RuleConfigPO</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Mapping(expression = &quot;java(String.join(\&quot;,\&quot;, mergeVO.getRuleParamIds()))&quot;, target = &quot;ruleParamId&quot;)</span></span><br><span class="line">    <span class="function">RuleConfigPO <span class="title">toModel</span><span class="params">(RuleConfigMergeVO mergeVO)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RuleConfigPO.MergeRuleConfigConvert CONFIG_MERGE_CONVERT = Mappers.getMapper(MergeRuleConfigConvert.class);</span><br></pre></td></tr></table></figure></li>
<li><p> 结合<code>lombok</code>插件, 实体类中涉及到继承父类属性, 并且都使用了<code>@SuperBuilder</code>, 自动生成的convert实现类不会出现问题</p>
</li>
<li><p> 如果手动设置<code>@Mapping</code>,且转换类在使用父类属性时, 需要设置 <code>@Mapper(builder = @org.mapstruct.Builder(disableBuilder = true)</code>, 否则自动生成convert实现类方法中会直接编译成了父类导致报错</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper(builder = @org.mapstruct.Builder(disableBuilder = true), imports = &#123;Arrays.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RuleConfigResConvert</span> <span class="keyword">extends</span> <span class="title">BaseConvert</span>&lt;<span class="title">RuleConfigResVO</span>, <span class="title">RuleConfigPO</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Mapping(expression = &quot;java(Arrays.asList(ruleConfigPO.getRuleParamId() .split(\&quot;,\&quot;)))&quot;, target = &quot;ruleParamIds&quot;)</span></span><br><span class="line">    <span class="function">RuleConfigResVO <span class="title">fromModel</span><span class="params">(RuleConfigPO ruleConfigPO)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RuleConfigPO.RuleConfigResConvert CONFIG_RES_CONVERT = Mappers.getMapper(RuleConfigPO.RuleConfigResConvert.class);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="springboot启动脚本加载优先级"><a href="#springboot启动脚本加载优先级" class="headerlink" title="springboot启动脚本加载优先级"></a>springboot启动脚本加载优先级</h2></li>
<li><p>没有指定配置文件的情况下当前jar包目录同级有配置文件或者有config文件夹, 优先加载外部的,会覆盖内部classes下的. </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动指定外部配置文件</span></span><br><span class="line">nohup java -Xms2048M -Xmx2048M -XX:MaxPermSize=512M -jar ./xxxxxxxx.jar -Dspring.config.location=./application.yml &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动指定环境变量加载配置文件</span></span><br><span class="line">nohup java -Xms2048M -Xmx2048M -XX:MaxPermSize=512M -jar ./xxxxxxxx.jar --spring.profiles.active=dev &gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<h2 id="hutool-excel工具"><a href="#hutool-excel工具" class="headerlink" title="hutool excel工具"></a>hutool excel工具</h2><blockquote>
<p>读取excel过慢, <strong>注意不同操作系统环境有内存泄露风险,  推荐使用easyexcel</strong></p>
</blockquote>
<h1 id="Es-相关"><a href="#Es-相关" class="headerlink" title="Es 相关"></a>Es 相关</h1><h2 id="ES-跨集群搜索设置"><a href="#ES-跨集群搜索设置" class="headerlink" title="ES 跨集群搜索设置"></a>ES 跨集群搜索设置</h2></li>
<li><p>elasticsearch.yml 相关配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node-1</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;node-1&quot;</span>]</span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">cluster_name</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">network.publish_host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>  <span class="comment">#一定要配置</span></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">xpack.ml.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></li>
<li><p>kibana.yml 设置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">server.shutdownTimeout:</span> <span class="string">&quot;5s&quot;</span></span><br><span class="line"> <span class="comment"># macos容器启动的kibana需要使用域名访问</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> [ <span class="string">&quot;http://docker.for.mac.host.internal:9201&quot;</span>] </span><br><span class="line"><span class="attr">monitoring.ui.container.elasticsearch.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">i18n.locale:</span> <span class="string">&quot;zh-CN&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>设置远程集群搜索</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot;: &#123;</span><br><span class="line">    &quot;cluster&quot;: &#123;</span><br><span class="line">      &quot;remote&quot;: &#123;</span><br><span class="line">        &quot;cluster_one&quot;: &#123;</span><br><span class="line">          &quot;seeds&quot;: [</span><br><span class="line">            &quot;IP:9300&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;cluster_two&quot;: &#123;</span><br><span class="line">          &quot;seeds&quot;: [</span><br><span class="line">            &quot;IP:9301&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;cluster_three&quot;: &#123;</span><br><span class="line">          &quot;seeds&quot;: [</span><br><span class="line">            &quot;IP:9302&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _cluster/health</span><br><span class="line"></span><br><span class="line">GET _remote/info</span><br><span class="line"></span><br><span class="line">GET flute_cluster:knowledgesearch/_search</span><br></pre></td></tr></table></figure>
<h2 id="组合查询"><a href="#组合查询" class="headerlink" title="组合查询"></a>组合查询</h2></li>
<li><p>example :   and condition1 or ( condition 2 and  condition 3)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">POST _search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;from&quot;: 0,</span><br><span class="line">    &quot;size&quot;: 20,</span><br><span class="line">    &quot;sort&quot;: &#123;&#125;,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;should&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;term&quot;: &#123;</span><br><span class="line">                        &quot;condition1&quot;: 0</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;bool&quot;: &#123;</span><br><span class="line">                        &quot;must&quot;: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                &quot;term&quot;: &#123;</span><br><span class="line">                                    &quot;condition2&quot;: 1</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            &#123;</span><br><span class="line">                                &quot;wildcard&quot;: &#123;</span><br><span class="line">                                    &quot;condition3&quot;: &#123;</span><br><span class="line">                                        &quot;wildcard&quot;: &quot;*115916589957645297*&quot;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Vue-相关"><a href="#Vue-相关" class="headerlink" title="Vue 相关"></a>Vue 相关</h1><h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2></li>
<li><p>vue-cli4 工程 <code>vue.config.js</code>设置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">chainWebpack: <span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">    config.module.rule(<span class="string">&#x27;svg&#x27;</span>)</span><br><span class="line">      .exclude.add(path.join(__dirname, <span class="string">&#x27;src/assets/icon&#x27;</span>))</span><br><span class="line">      .end()</span><br><span class="line">    config.module</span><br><span class="line">      .rule(<span class="string">&#x27;icons&#x27;</span>)</span><br><span class="line">      .test(<span class="regexp">/\.svg$/</span>).include</span><br><span class="line">      .add(path.join(__dirname, <span class="string">&#x27;src/assets/icon&#x27;</span>))</span><br><span class="line">      .end()</span><br><span class="line">      .use(<span class="string">&#x27;svg-sprite-loader&#x27;</span>)</span><br><span class="line">      .loader(<span class="string">&#x27;svg-sprite-loader&#x27;</span>)</span><br><span class="line">      .options(&#123; <span class="attr">symbolId</span>: <span class="string">&#x27;icon-[name]&#x27;</span> &#125;)</span><br><span class="line">      .end()</span><br><span class="line">    config.module</span><br><span class="line">      .rule(<span class="string">&#x27;image&#x27;</span>)</span><br><span class="line">      .test(<span class="regexp">/\.(png|jpe?g|gif)(\?.*)?$/</span>)</span><br><span class="line">      .use(<span class="string">&#x27;image-webpack-loader&#x27;</span>)</span><br><span class="line">      .loader(<span class="string">&#x27;image-webpack-loader&#x27;</span>)</span><br><span class="line">      .options(&#123;</span><br><span class="line">        <span class="comment">// 此处为ture的时候不会启用压缩处理,目的是为了开发模式下调试速度更快</span></span><br><span class="line">        <span class="attr">disable</span>: process.env.NODE_ENV === <span class="string">&#x27;development&#x27;</span></span><br><span class="line">      &#125;).end()</span><br><span class="line">    </span><br><span class="line">    config.when(process.env.VUE_BUILD_CONF === <span class="string">&#x27;prod&#x27;</span>,</span><br><span class="line">      <span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">        config.plugin(<span class="string">&#x27;CompressionPlugin&#x27;</span>).use(<span class="string">&#x27;compression-webpack-plugin&#x27;</span>, [&#123;</span><br><span class="line">          <span class="attr">filename</span>: <span class="string">&#x27;[path][base].gz&#x27;</span>,</span><br><span class="line">          <span class="attr">algorithm</span>: <span class="string">&#x27;gzip&#x27;</span>,</span><br><span class="line">          <span class="comment">// 要压缩的文件（正则）</span></span><br><span class="line">          <span class="attr">test</span>: <span class="regexp">/\.(js|css|json|txt|ico|svg)(\?.*)?$/i</span>,</span><br><span class="line">          <span class="comment">// 最小文件开启压缩</span></span><br><span class="line">          threshold: <span class="number">10240</span>,</span><br><span class="line">          <span class="attr">minRatio</span>: <span class="number">0.8</span></span><br><span class="line">        &#125;])</span><br><span class="line">        config</span><br><span class="line">          .plugin(<span class="string">&#x27;ScriptExtHtmlWebpackPlugin&#x27;</span>)</span><br><span class="line">          .after(<span class="string">&#x27;html&#x27;</span>)</span><br><span class="line">          .use(<span class="string">&#x27;script-ext-html-webpack-plugin&#x27;</span>, [&#123;</span><br><span class="line">            <span class="attr">inline</span>: <span class="regexp">/runtime\..*\.js$/</span></span><br><span class="line">          &#125;])</span><br><span class="line">          .end()</span><br><span class="line"></span><br><span class="line">        config</span><br><span class="line">          .optimization.splitChunks(&#123;</span><br><span class="line">            <span class="attr">chunks</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line">            <span class="attr">cacheGroups</span>: &#123;</span><br><span class="line">              <span class="attr">libs</span>: &#123;</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&#x27;chunk-libs&#x27;</span>,</span><br><span class="line">                <span class="attr">test</span>: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">                priority: <span class="number">10</span>,</span><br><span class="line">                <span class="attr">chunks</span>: <span class="string">&#x27;initial&#x27;</span> <span class="comment">// only package third parties that are initially dependent</span></span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">elementUI</span>: &#123;</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&#x27;chunk-elementUI&#x27;</span>, <span class="comment">// split elementUI into a single package</span></span><br><span class="line">                <span class="attr">priority</span>: <span class="number">20</span>, <span class="comment">// the weight needs to be larger than libs and app or it will be packaged into libs or app</span></span><br><span class="line">                <span class="attr">test</span>: <span class="regexp">/[\\/]node_modules[\\/]_?element-ui(.*)/</span> <span class="comment">// in order to adapt to cnpm</span></span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">commons</span>: &#123;</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&#x27;chunk-commons&#x27;</span>,</span><br><span class="line">                <span class="attr">test</span>: resolve(<span class="string">&#x27;src/components&#x27;</span>), <span class="comment">// can customize your rules</span></span><br><span class="line">                <span class="attr">minChunks</span>: <span class="number">3</span>, <span class="comment">//  minimum common number</span></span><br><span class="line">                <span class="attr">priority</span>: <span class="number">5</span>,</span><br><span class="line">                <span class="attr">reuseExistingChunk</span>: <span class="literal">true</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        config.optimization.runtimeChunk(<span class="string">&#x27;single&#x27;</span>)</span><br><span class="line">        <span class="comment">// 去掉debugger console</span></span><br><span class="line">        config.optimization.minimizer(<span class="string">&#x27;terser&#x27;</span>).tap(<span class="function">(<span class="params">args</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 注释console.*</span></span><br><span class="line">          args[<span class="number">0</span>].terserOptions.compress.drop_console = <span class="literal">true</span></span><br><span class="line">          <span class="comment">// remove debugger</span></span><br><span class="line">          args[<span class="number">0</span>].terserOptions.compress.drop_debugger = <span class="literal">true</span></span><br><span class="line">          <span class="comment">// 移除 console.log</span></span><br><span class="line">          args[<span class="number">0</span>].terserOptions.compress.pure_funcs = [<span class="string">&#x27;console.log&#x27;</span>]</span><br><span class="line">          <span class="comment">// 去掉注释 如果需要看chunk-vendors公共部分插件，可以注释掉就可以看到注释了</span></span><br><span class="line">          args[<span class="number">0</span>].terserOptions.output = &#123;</span><br><span class="line">            <span class="attr">comments</span>: <span class="literal">false</span></span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="keyword">return</span> args</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h1 id="使用docker-安装使用-onlyoffice"><a href="#使用docker-安装使用-onlyoffice" class="headerlink" title="使用docker 安装使用 onlyoffice"></a>使用docker 安装使用 onlyoffice</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2></li>
<li><p>如果开启使用<code>example</code>页面功能, 需要需要配置<code>/etc/onlyoffice/documentserver-example/default.json</code>文件中的 example 的地址,配置为 docker 网卡地址</p>
<h2 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h2></li>
<li><p>onlyoffice 是使用 jwt 签名进行验证用户的真实性以及请求来源的真实性</p>
</li>
<li><p>在 7.2 版本后默认启用了 jwt认证 功能, 启动服务会生成相应的签名密钥, 签名的secret密钥可以在 <code>/etc/onlyoffice/documentserver/local.json</code>中找到, 调用onlyoffice 页面时一定需要携带 token内容, 完整的参数如下 e.g</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;document&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;info&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;Me&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;favorite&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;uploaded&quot;</span>: <span class="string">&quot;Wed Sep 13 2023&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;permissions&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;comment&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;copy&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;download&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;edit&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;print&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;fillForms&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;modifyFilter&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;modifyContentControl&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;review&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;chat&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;commentGroups&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">&quot;protect&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;fileType&quot;</span>: <span class="string">&quot;docx&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;1671695205&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;urlUser&quot;</span>: <span class="string">&quot;http://localhost:4000/download?fileName=new.docx&amp;userAddress%2FUsers%2Fdy%2FDevSoftWare%2Fidea%2Fgithub%2Fonlyoffice-example%2Fdocuments%2F127.0.0.1%2F&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;new.docx&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;http://localhost:4000/download?fileName=new.docx&amp;userAddress=%2FUsers%2Fdy%2FDevSoftWare%2Fidea%2Fgithub%2Fonlyoffice-example%2Fdocuments%2F127.0.0.1%2F&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;directUrl&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;referenceData&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;instanceId&quot;</span>: <span class="string">&quot;http://localhost:4000&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;fileKey&quot;</span>: <span class="string">&quot;&#123;\&quot;userAddress\&quot;:\&quot;127.0.0.1\&quot;,\&quot;fileName\&quot;:\&quot;new.docx\&quot;&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;documentType&quot;</span>: <span class="string">&quot;word&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;editorConfig&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;actionLink&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;callbackUrl&quot;</span>: <span class="string">&quot;http://localhost:4000/track?fileName=new.docx&amp;userAddress=%2FUsers%2Fdy%2FDevSoftWare%2Fidea%2Fgithub%2Fonlyoffice-example%2Fdocuments%2F127.0.0.1%2F&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;coEditing&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;createUrl&quot;</span>: <span class="string">&quot;http://localhost:4000/create?fileExt=docx&amp;sample=false&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;customization&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;logo&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;image&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;imageEmbedded&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://www.onlyoffice.com&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;goback&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;http://localhost:4000/&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;autosave&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;comments&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;compactHeader&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;compactToolbar&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;compatibleFeatures&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;forcesave&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;help&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;hideRightMenu&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;hideRulers&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;submitForm&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;about&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;feedback&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;embedded&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;embedUrl&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;saveUrl&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;shareUrl&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;toolbarDocked&quot;</span>: <span class="literal">null</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;lang&quot;</span>: <span class="string">&quot;en&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;edit&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;user&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;John Smith&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;group&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;templates&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;image&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Blank&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;http://localhost:4000/create?fileExt=docx&amp;sample=false&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;image&quot;</span>: <span class="string">&quot;http://localhost:4000/css/img/file_docx.svg&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;With sample content&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;http://localhost:4000/create?fileExt=docx&amp;sample=true&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;desktop&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;width&quot;</span>: <span class="string">&quot;100%&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;100%&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;events&quot;</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>请求原理: 后端生成配置信息以及使用 onlyOffice提供的secret 密钥将配置信息进行jwt签名, 生成 token一并返回,  页面携带 token 以及文件地址访问 onlyoffice 服务, 借助 onlyoffice 的 api 打开编辑或预览文件</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2></li>
<li><p>在官方提供的后端spring 例子中, 创建文件无法打开页面问题, 在 chrome 中, 不安全的网站(非 https)内容默认是阻止重定向的, 在 chrome输入<code>chrome://settings/content</code>中找到相应网站设置不安全内容设置为允许</p>
</li>
<li><p>打开文件提示文件下载失败: 最主要的问题是documentServer无法访问应用服务后端提供的文件地址, 检查页面返回的editorConfig对象中的url地址ip是否允许documentServer访问</p>
<h2 id="springboot-批量获取redis-key超时问题"><a href="#springboot-批量获取redis-key超时问题" class="headerlink" title="springboot 批量获取redis key超时问题"></a>springboot 批量获取redis key超时问题</h2></li>
</ul>
<p>Scan命令是一种比Keys命令更加高效、安全的遍历Redis key的方式,可以减少因为大量 key 集中在一起而导致的阻塞和性能问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实例化 RedisTemplate (按实际场景使用template)</span></span><br><span class="line">RedisTemplate&lt;String, String&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">redisTemplate.setConnectionFactory(connectionFactory);</span><br><span class="line">redisTemplate.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造 ScanOptions</span></span><br><span class="line">ScanOptions options = ScanOptions.scanOptions().match(<span class="string">&quot;prefix:*&quot;</span>).count(<span class="number">1000</span>).build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 ScanCursor</span></span><br><span class="line">ScanCursor&lt;String&gt; cursor = (ScanCursor&lt;String&gt;) redisTemplate.executeWithStickyConnection((RedisCallback) redisConnection -&gt; &#123;</span><br><span class="line">    Cursor&lt;<span class="keyword">byte</span>[]&gt; cursor1 = redisConnection.scan(options);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ScanCursorWrapper(cursor1);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历 ScanCursor</span></span><br><span class="line"><span class="keyword">while</span> (cursor.hasNext()) &#123;</span><br><span class="line">    String key = cursor.next();</span><br><span class="line">    <span class="comment">// 对 key 进行操作</span></span><br><span class="line">    <span class="comment">// 有可能出现重复的key需要去重</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">	* redisTemplate</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title">getKeysByPattern</span><span class="params">(String keyPattern)</span> </span>&#123;  </span><br><span class="line">	log.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; clean keys&quot;</span>);  </span><br><span class="line">	<span class="keyword">return</span> redisTemplate.execute((RedisCallback&lt;Set&lt;String&gt;&gt;) connection -&gt; &#123;  </span><br><span class="line">				Set&lt;String&gt; keys = <span class="keyword">new</span> HashSet&lt;&gt;();  </span><br><span class="line">				Cursor&lt;<span class="keyword">byte</span>[]&gt; cursor = connection.scan(ScanOptions.scanOptions().match(keyPattern+ <span class="string">&quot;  *&quot;</span>).count(<span class="number">10000</span>).build());</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">while</span> (cursor.hasNext()) &#123;  </span><br><span class="line">					keys.add(<span class="keyword">new</span> String(cursor.next()));  </span><br><span class="line">				&#125;  </span><br><span class="line">				cursor.close();  </span><br><span class="line">				<span class="keyword">return</span> keys;  </span><br><span class="line">	&#125;);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>首先实例化 RedisTemplate，并设置了它的连接工厂和属性。然后构造了一个 ScanOptions，用于指定 Scan 的参数，包括需要匹配的 key 前缀和每次返回的 key 数量等。接着通过 RedisTemplate 的 executeWithStickyConnection 方法执行 RedisCallback，获取一个 ScanCursor。最后遍历 ScanCursor 并对每个 key 进行操作。</p>
<p>需要注意的是，Scan 命令的返回结果是一个游标，需要通过循环遍历来获取所有的 key。同时，如果在循环遍历过程中有新的 key 被添加到 Redis 中，也有可能被遗漏。因此，在遍历过程中需要保证数据的一致性和可靠性。</p>
<h2 id="Maven-wrapper-代理地址"><a href="#Maven-wrapper-代理地址" class="headerlink" title="Maven wrapper 代理地址"></a>Maven wrapper 代理地址</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">distributionUrl</span>=<span class="string">https://mirrors.huaweicloud.com/repository/maven/org/apache/maven/apache-maven/3.6.3/apache-maven-3.6.3-bin.zip</span></span><br><span class="line"><span class="attr">wrapperUrl</span>=<span class="string">https://mirrors.huaweicloud.com/repository/maven/io/takari/maven-wrapper/0.5.6/maven-wrapper-0.5.6.jar</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/workspace/" rel="tag"># workspace</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/articles/2023/05/10/dev-standard/" rel="prev" title="前后端开发规范">
      <i class="fa fa-chevron-left"></i> 前后端开发规范
    </a></div>
      <div class="post-nav-item">
    <a href="/articles/2023/10/18/confluence/" rel="next" title="使用 docker + confluence 搭建企业内部wiki">
      使用 docker + confluence 搭建企业内部wiki <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-boot-%E7%9B%B8%E5%85%B3"><span class="nav-number">1.</span> <span class="nav-text">Spring boot 相关</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%A0%E9%94%99"><span class="nav-number">1.1.</span> <span class="nav-text">纠错</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Cloud-Open-Fegin"><span class="nav-number">1.2.</span> <span class="nav-text">Spring Cloud Open Fegin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Springboot2-x"><span class="nav-number">1.3.</span> <span class="nav-text">Springboot2.x</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Springboot-data-redis-%E5%92%8Cdata-elasticsearch%E4%B8%AD%E7%9A%84netty%E5%86%B2%E7%AA%81"><span class="nav-number">1.4.</span> <span class="nav-text">Springboot data redis 和data-elasticsearch中的netty冲突</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">1.4.1.</span> <span class="nav-text">使用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">1.4.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.4.3.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-boot%E4%B8%AD%E7%9A%84-Order%E6%B3%A8%E8%A7%A3"><span class="nav-number">1.5.</span> <span class="nav-text">spring-boot中的@Order注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-boot-%E4%BE%9D%E8%B5%96%E5%A4%96%E9%83%A8jar%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">1.6.</span> <span class="nav-text">spring-boot 依赖外部jar的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E9%85%8D%E7%BD%AE"><span class="nav-number">1.6.1.</span> <span class="nav-text">依赖配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%8C%85%E9%85%8D%E7%BD%AE"><span class="nav-number">1.6.2.</span> <span class="nav-text">打包配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-interceptor%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E9%A1%B9"><span class="nav-number">1.7.</span> <span class="nav-text">spring interceptor使用注意项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-boot-validator-%E6%A0%A1%E9%AA%8C-%E5%92%8C-%E7%8B%AC%E7%AB%8B%E9%85%8D%E7%BD%AE%E8%BF%94%E5%9B%9E%E6%B6%88%E6%81%AF%E5%86%85%E5%AE%B9%E6%95%B4%E5%90%88"><span class="nav-number">1.8.</span> <span class="nav-text">Spring boot validator 校验 和 独立配置返回消息内容整合</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B6%88%E6%81%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">1.8.1.</span> <span class="nav-text">加载自定义消息配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E5%B7%A5%E7%A8%8B%E5%A4%9A%E6%A8%A1%E5%9D%97message%E6%96%87%E4%BB%B6%E7%9A%84%E5%A4%84%E7%90%86"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">聚合工程多模块message文件的处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E6%A0%A1%E9%AA%8C%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%E4%BF%A1%E6%81%AF%E9%85%8D%E7%BD%AE"><span class="nav-number">1.8.1.2.</span> <span class="nav-text">声明校验错误提示信息配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95"><span class="nav-number">1.8.1.3.</span> <span class="nav-text">异常处理方法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Springboot%E4%BD%BF%E7%94%A8-RequestPart"><span class="nav-number">1.9.</span> <span class="nav-text">Springboot使用 @RequestPart</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF"><span class="nav-number">1.9.1.</span> <span class="nav-text">场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90"><span class="nav-number">1.9.2.</span> <span class="nav-text">例子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">1.9.3.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-boot-%E5%86%85%E7%BD%AEtomcat%E8%AE%BE%E7%BD%AE"><span class="nav-number">1.10.</span> <span class="nav-text">spring boot 内置tomcat设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ali-QL-Express-%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8"><span class="nav-number">1.11.</span> <span class="nav-text">Ali QL Express 工具使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Java-Timer-vs-ExecutorService"><span class="nav-number">1.12.</span> <span class="nav-text">Java Timer vs ExecutorService?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mapstruct-%E6%8F%92%E4%BB%B6"><span class="nav-number">1.13.</span> <span class="nav-text">Mapstruct 插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#springboot%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-number">1.14.</span> <span class="nav-text">springboot启动脚本加载优先级</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hutool-excel%E5%B7%A5%E5%85%B7"><span class="nav-number">1.15.</span> <span class="nav-text">hutool excel工具</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Es-%E7%9B%B8%E5%85%B3"><span class="nav-number">2.</span> <span class="nav-text">Es 相关</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ES-%E8%B7%A8%E9%9B%86%E7%BE%A4%E6%90%9C%E7%B4%A2%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.1.</span> <span class="nav-text">ES 跨集群搜索设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%84%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.2.</span> <span class="nav-text">组合查询</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Vue-%E7%9B%B8%E5%85%B3"><span class="nav-number">3.</span> <span class="nav-text">Vue 相关</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96"><span class="nav-number">3.1.</span> <span class="nav-text">优化</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8docker-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8-onlyoffice"><span class="nav-number">4.</span> <span class="nav-text">使用docker 安装使用 onlyoffice</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">4.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE"><span class="nav-number">4.2.</span> <span class="nav-text">访问</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-number">4.3.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#springboot-%E6%89%B9%E9%87%8F%E8%8E%B7%E5%8F%96redis-key%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98"><span class="nav-number">4.4.</span> <span class="nav-text">springboot 批量获取redis key超时问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Maven-wrapper-%E4%BB%A3%E7%90%86%E5%9C%B0%E5%9D%80"><span class="nav-number">4.5.</span> <span class="nav-text">Maven wrapper 代理地址</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="olsond"
      src="/images/avatar_olsond.jpg">
  <p class="site-author-name" itemprop="name">olsond</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Olsondy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Olsondy" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/javady" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;javady" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">olsond</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  <script type="text/javascript" src="/js/src/clicklove.js"></script>
</body>
</html>
